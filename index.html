<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FocusFlow - Smart Daily Planner</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div id="authModal" class="auth-modal">
        <div class="auth-container">
            <div class="auth-header-section">
                <div class="auth-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                        <path d="M2 17l10 5 10-5"/>
                        <path d="M2 12l10 5 10-5"/>
                    </svg>
                </div>
                <h1 class="auth-title">FocusFlow</h1>
                <p class="auth-subtitle">Optimize your day with AI-powered task scheduling</p>
                <div class="auth-divider"></div>
            </div>
            <h2 id="authTitle" class="form-title">Sign In</h2>
            <form id="authForm">
                <div class="input-group" id="usernameGroup" style="display: none;">
                    <input type="text" id="authUsername" name="username" placeholder="Username">
                </div>
                <div class="input-group">
                    <input type="email" id="authEmail" placeholder="Email" required>
                </div>
                <div class="input-group">
                    <input type="password" id="authPassword" placeholder="Password" required>
                </div>
                <button type="submit" class="auth-btn" id="authSubmitBtn">Sign In</button>
            </form>
            <p id="authToggle" class="auth-switch">Don't have an account? <a href="#">Sign Up</a></p>
            <div id="authError" class="auth-error"></div>
        </div>
    </div>

    <div class="container" id="gameContainer" style="display: none;">
        <header class="header">
            <div class="header-content">
                <h1 class="logo">
                    <svg class="logo-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                        <path d="M2 17l10 5 10-5"/>
                        <path d="M2 12l10 5 10-5"/>
                    </svg>
                    FocusFlow
                </h1>
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme">
                        <svg class="sun-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="5"/>
                            <line x1="12" y1="1" x2="12" y2="3"/>
                            <line x1="12" y1="21" x2="12" y2="23"/>
                            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                            <line x1="1" y1="12" x2="3" y2="12"/>
                            <line x1="21" y1="12" x2="23" y2="12"/>
                            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                        </svg>
                        <svg class="moon-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </button>
                    <div class="user-info">
                        <span id="userEmail" style="color: var(--text-secondary); margin-right: 1rem;"></span>
                        <button class="btn btn-secondary" id="signOutBtn" style="padding: 0.5rem 1rem;">
                            Sign Out
                        </button>
                    </div>
                </div>
            </div>
            <p class="subtitle">Optimize your day with AI-powered task scheduling</p>
        </header>

        <main class="main-content">
            <section class="card task-input-section">
                <h2 class="section-title">Add Your Tasks</h2>
                <form id="taskForm" class="task-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="taskName">Task Name</label>
                            <input type="text" id="taskName" placeholder="e.g., Morning Workout" required>
                        </div>
                        <div class="form-group">
                            <label for="taskDuration">Duration (minutes)</label>
                            <input type="number" id="taskDuration" placeholder="60" min="1" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="taskPriority">Priority (1-5)</label>
                            <input type="number" id="taskPriority" placeholder="5" min="1" max="5" required>
                        </div>
                        <div class="form-group">
                            <label for="taskCategory">Category</label>
                            <select id="taskCategory" required>
                                <option value="work">Work</option>
                                <option value="health">Health</option>
                                <option value="learning">Learning</option>
                                <option value="chore">Chore</option>
                                <option value="relaxation">Relaxation</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"/>
                            <line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        Add Task
                    </button>
                </form>

                <div class="time-setting">
                    <label for="availableTime">Available Time (hours)</label>
                    <input type="number" id="availableTime" value="8" min="1" max="24" step="0.5">
                </div>

                <div class="method-setting">
                    <label for="optimizationMethod">Select Optimization Method</label>
                    <select id="optimizationMethod" required>
                        <option value="0/1">0/1 Knapsack</option>
                        <option value="fractional">Fractional Knapsack</option>
                    </select>
                    <p class="method-help-text">0/1 Knapsack includes or excludes tasks entirely; Fractional Knapsack may include part of a task if time allows.</p>
                </div>
            </section>

            <section class="card task-list-section">
                <div class="section-header">
                    <h2 class="section-title">Your Tasks</h2>
                    <span class="task-count" id="taskCount">0 tasks</span>
                </div>
                <div id="taskList" class="task-list">
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                            <line x1="9" y1="9" x2="15" y2="9"/>
                            <line x1="9" y1="15" x2="15" y2="15"/>
                        </svg>
                        <p>No tasks yet. Add your first task above!</p>
                    </div>
                </div>
                <div class="action-buttons">
                    <button id="optimizeBtn" class="btn btn-success" disabled>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                        </svg>
                        Optimize My Day
                    </button>
                    <button id="loadBtn" class="btn btn-secondary">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="7 10 12 15 17 10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                        Load Tasks
                    </button>
                </div>
            </section>

            <section class="card results-section" id="resultsSection" style="display: none;">
                <h2 class="section-title">Optimization Results</h2>
                
                <div class="results-summary">
                    <div class="summary-card">
                        <div class="summary-icon">⏱️</div>
                        <div class="summary-content">
                            <span class="summary-label">Total Time</span>
                            <span class="summary-value" id="totalTime">0 min</span>
                        </div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-icon">⭐</div>
                        <div class="summary-content">
                            <span class="summary-label">Total Value</span>
                            <span class="summary-value" id="totalValue">0</span>
                        </div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-icon">✅</div>
                        <div class="summary-content">
                            <span class="summary-label">Tasks Included</span>
                            <span class="summary-value" id="tasksIncluded">0</span>
                        </div>
                    </div>
                </div>

                <div class="results-content">
                    <div class="optimized-tasks">
                        <h3>Optimized Schedule</h3>
                        <div id="optimizedTasksList" class="result-task-list"></div>
                    </div>
                    
                    <div class="skipped-tasks">
                        <h3>Skipped Tasks</h3>
                        <div id="skippedTasksList" class="result-task-list"></div>
                    </div>
                </div>

                <div class="explanation">
                    <h3>AI Explanation</h3>
                    <p id="explanationText"></p>
                </div>
            </section>
        </main>

        <footer class="footer">
            <p id="footerText">Powered by 0/1 Knapsack Dynamic Programming Algorithm</p>
        </footer>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "",
            authDomain: "ai-habit-optimizer.firebaseapp.com",
            databaseURL: "https://ai-habit-optimizer-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "ai-habit-optimizer",
            storageBucket: "ai-habit-optimizer.firebasestorage.app",
            messagingSenderId: "1071389121603",
            appId: "1:1071389121603:web:09f3236bf3a2c10ce388f6",
            measurementId: "G-CJNBZVRZJW"
        };

        let auth = null;
        let db = null;

        function initializeFirebase() {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                auth = firebase.auth();
                db = firebase.database();
                
                window.firebaseDb = db;
                window.firebaseAuth = auth;
                
                console.log("[v0] Firebase initialized successfully");
                console.log("[v0] Firebase Database URL:", firebaseConfig.databaseURL);
                setupAuthListeners();
            } catch (error) {
                console.error("[v0] Firebase initialization error:", error);
            }
        }

        function setupAuthListeners() {
            const authModal = document.getElementById('authModal');
            const gameContainer = document.getElementById('gameContainer');
            const userEmail = document.getElementById('userEmail');
            const authForm = document.getElementById('authForm');
            const authToggle = document.getElementById('authToggle');
            const authTitle = document.getElementById('authTitle');
            const authSubmitBtn = document.getElementById('authSubmitBtn');
            const authError = document.getElementById('authError');
            const signOutBtn = document.getElementById('signOutBtn');
            const usernameGroup = document.getElementById('usernameGroup');
            const authUsername = document.getElementById('authUsername');

            let isSignUp = false;

            // Auth state observer
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    console.log("[v0] User logged in:", user.email);
                    console.log("[v0] User ID:", user.uid);
                    
                    let username = localStorage.getItem('username');
                    if (!username) {
                        try {
                            const usernameRef = db.ref(`usernames/${user.uid}`);
                            const snapshot = await usernameRef.once('value');
                            username = snapshot.val();
                            if (username) {
                                localStorage.setItem('username', username);
                                console.log("[v0] Username fetched from Firebase:", username);
                            }
                        } catch (error) {
                            console.error("[v0] Error fetching username:", error);
                        }
                    }
                    
                    authModal.style.display = 'none';
                    gameContainer.style.display = 'block';
                    userEmail.textContent = user.email;
                    
                    window.currentUserId = user.uid;
                    window.currentUserEmail = user.email;
                    window.currentUsername = username;
                } else {
                    console.log("[v0] User logged out");
                    authModal.style.display = 'flex';
                    gameContainer.style.display = 'none';
                    window.currentUserId = null;
                    window.currentUserEmail = null;
                    window.currentUsername = null;
                }
            });

            // Toggle between sign in and sign up
            authToggle.addEventListener('click', (e) => {
                // Only run if the user clicked the <a> tag
                if (e.target.tagName !== 'A') return; 
                
                e.preventDefault();
                isSignUp = !isSignUp;
                
                if (isSignUp) {
                    authTitle.textContent = 'Sign Up';
                    authSubmitBtn.textContent = 'Sign Up';
                    usernameGroup.style.display = 'block';
                    authUsername.required = true;
                    authToggle.innerHTML = 'Already have an account? <a href="#">Sign In</a>';
                } else {
                    authTitle.textContent = 'Sign In';
                    authSubmitBtn.textContent = 'Sign In';
                    usernameGroup.style.display = 'none';
                    authUsername.required = false;
                    authToggle.innerHTML = 'Don\'t have an account? <a href="#">Sign Up</a>';
                }
                authError.textContent = '';
            });

            // Handle form submission
            authForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('authEmail').value;
                const password = document.getElementById('authPassword').value;
                const username = document.getElementById('authUsername').value;
                authError.textContent = '';

                try {
                    if (isSignUp) {
                        if (!username) {
                            authError.textContent = 'Username is required for signup';
                            return;
                        }
                        console.log("[v0] Attempting to sign up user:", email, "with username:", username);
                        const result = await auth.createUserWithEmailAndPassword(email, password);
                        console.log("[v0] User signed up successfully:", result.user.email);
                        
                        try {
                            const usernameRef = db.ref(`usernames/${result.user.uid}`);
                            await usernameRef.set(username);
                            console.log("[v0] Username mapping saved to Firebase:", result.user.uid, "->", username);
                        } catch (error) {
                            console.error("[v0] Error saving username mapping:", error);
                            authError.textContent = 'Failed to save username. Please. Please try again.';
                            return;
                        }
                        
                        window.currentUsername = username;
                        localStorage.setItem('username', username);
                    } else {
                        console.log("[v0] Attempting to sign in user:", email);
                        const result = await auth.signInWithEmailAndPassword(email, password);
                        console.log("[v0] User signed in successfully:", result.user.email);
                    }
                } catch (error) {
                    console.error("[v0] Auth error:", error.message);
                    authError.textContent = error.message;
                    authError.style.color = '#ff6b6b';
                    authError.style.marginTop = '1rem';
                }
            });

            // Sign out handler
            signOutBtn.addEventListener('click', async () => {
                try {
                    console.log("[v0] User signing out");
                    await auth.signOut();
                    localStorage.removeItem('username');
                    console.log("[v0] User signed out successfully");
                } catch (error) {
                    console.error("[v0] Sign out error:", error.message);
                }
            });
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();
        });
    </script>
    
    <script src="script.js"></script>
</body>
</html>
